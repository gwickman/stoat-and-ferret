# Requirements: text-overlay-apply

## Goal

Create POST endpoint to apply text overlay to clips with validation, persistence, and filter preview.

## Background

Backlog Item: BL-043 (partial — endpoint layer)

The Rust drawtext builder (BL-040) generates filter strings and the clip effect model (clip-effect-model feature) stores effect configurations. This feature bridges them with a REST endpoint that receives text overlay parameters, validates them via the Rust builder, stores the configuration on the clip, and returns the generated FFmpeg filter string for transparency.

## Functional Requirements

**FR-001: POST endpoint**
- POST endpoint applies text overlay parameters to a specified clip
- AC: Endpoint accepts clip ID and text overlay parameters, returns 200 with effect details

**FR-002: Effect persistence**
- Effect configuration stored persistently in the clip model (via clip-effect-model feature)
- AC: After applying, GET clip returns the effect in its effects list

**FR-003: Filter string transparency**
- Response includes the generated FFmpeg filter string
- AC: Response body contains the FFmpeg drawtext filter string generated by the Rust builder

**FR-004: Rust validation**
- Validation errors from Rust drawtext builder surface as structured API error responses
- AC: Invalid parameters return 422 with structured error details from Rust validation

**FR-005: Black box test**
- End-to-end test covers the apply -> verify filter string flow
- AC: System test posts text overlay, retrieves clip, verifies effect stored and filter string correct

**FR-006: WebSocket events**
- Emit `effect.applied` event on successful application
- Emit `effect.removed` event on effect removal
- Extend existing `EventType` enum in `src/stoat_ferret/api/websocket/events.py`
- AC: WebSocket subscribers receive events when effects are applied or removed

## Non-Functional Requirements

**NFR-001: Error quality**
- Rust validation errors provide parameter-specific feedback
- AC: Error response identifies which parameter(s) failed validation and why

**NFR-002: Test coverage**
- Python coverage maintained above 80% threshold
- AC: Endpoint, error handling, and WebSocket event tests have comprehensive coverage

## Out of Scope

- Batch effect application (multiple effects in one request)
- Effect undo/redo (history concern)
- Effect preview rendering (generates filter string only, not rendered output)
- Speed control application endpoint (v006 provides discovery only; apply endpoint is v007)

## Test Requirements

- **Unit tests:** Endpoint handler (parameter validation, Rust builder invocation, effect storage on clip), error handling (Rust validation errors as structured API responses), WebSocket events (`effect.applied` emitted), filter string transparency (response includes FFmpeg filter string)
- **System/Golden tests:** Black box test: POST text overlay → verify effect stored → verify filter string in response

Reference: `See comms/outbox/versions/design/v006/004-research/ for supporting evidence`
