# Validation Details - v008

## 1. Content Completeness

### Methodology
Compared all 12 Task 007 draft files against their persisted counterparts in `comms/inbox/versions/execution/v008/`. Also verified the STARTER_PROMPT.md (persisted-only, generated by persist tool).

### Results

| # | Document | Status | Details |
|---|----------|--------|---------|
| 1 | VERSION_DESIGN.md | Restructured | Persist tool reformatted into standard template. "Key Design Decisions" section (5 items) not in persisted version but preserved in individual THEME_DESIGN and feature docs. Backlog Items, Success Criteria, Rationale sections added. |
| 2 | THEME_INDEX.md | Enriched | Persisted adds execution instructions, folder paths, expanded goal text, Notes section. No content lost. Minor: missing blank line between Theme 01 features and Theme 02 header. |
| 3 | application-startup-wiring/THEME_DESIGN.md | Identical | Trailing newline only |
| 4 | ci-stability/THEME_DESIGN.md | Identical | Trailing newline only |
| 5 | database-startup/requirements.md | Identical | Trailing newline only |
| 6 | database-startup/implementation-plan.md | Identical | Trailing newline only |
| 7 | logging-startup/requirements.md | Identical | Trailing newline only |
| 8 | logging-startup/implementation-plan.md | Identical | Trailing newline only |
| 9 | orphaned-settings/requirements.md | Identical | Trailing newline only |
| 10 | orphaned-settings/implementation-plan.md | Identical | Trailing newline only |
| 11 | flaky-e2e-fix/requirements.md | Identical | Trailing newline only |
| 12 | flaky-e2e-fix/implementation-plan.md | Identical | Trailing newline only |
| 13 | STARTER_PROMPT.md | Persisted-only | 46 lines, well-formed, expected from persist phase |

### Assessment
No truncation. 10/12 pairs identical. 2 pairs differ due to persist tool template formatting (enrichment, not loss). All design intent preserved across the full document corpus.

---

## 2. Reference Resolution

### References Found in Inbox Documents

| Source Document | Reference Target | Resolves? |
|----------------|-----------------|-----------|
| 01-application-startup-wiring/THEME_DESIGN.md:9 | `comms/outbox/versions/design/v008/006-critical-thinking/` | Yes (4 files) |
| 02-ci-stability/THEME_DESIGN.md:9 | `comms/outbox/versions/design/v008/006-critical-thinking/` | Yes (4 files) |
| 001-database-startup/requirements.md:68 | `comms/outbox/versions/design/v008/004-research/` | Yes (4 files) |
| 002-logging-startup/requirements.md:73 | `comms/outbox/versions/design/v008/004-research/` | Yes (4 files) |
| 003-orphaned-settings/requirements.md:58 | `comms/outbox/versions/design/v008/004-research/` | Yes (4 files) |
| 001-flaky-e2e-fix/requirements.md:52 | `comms/outbox/versions/design/v008/004-research/` | Yes (4 files) |

### Design Artifact Store Contents (23 files)

```
comms/outbox/versions/design/v008/
  001-environment/   (3 files: README.md, environment-checks.md, version-context.md)
  002-backlog/       (4 files: README.md, backlog-details.md, retrospective-insights.md, learnings-summary.md)
  003-impact-assessment/ (3 files: impact-table.md, impact-summary.md, README.md)
  004-research/      (4 files: README.md, codebase-patterns.md, external-research.md, evidence-log.md, impact-analysis.md)
  005-logical-design/ (4 files: logical-design.md, test-strategy.md, risks-and-unknowns.md, README.md)
  006-critical-thinking/ (4 files: risk-assessment.md, refined-logical-design.md, investigation-log.md, README.md)
```

---

## 3. Notes Propagation

### BL-055 (flaky E2E test) -> 001-flaky-e2e-fix/requirements.md
- v007 execution halt context preserved
- Root cause analysis (5000ms default Playwright timeout vs CI timing)
- Post-merge validation criterion (10 consecutive CI runs) documented
- Follow-up backlog item instruction if flake reappears

### BL-056 (logging startup) -> 002-logging-startup/requirements.md
- Idempotency gap documented (unconditional StreamHandler addition)
- Placement criticality noted (before `_deps_injected` guard)
- All 9 structlog modules counted
- `settings.log_level` consumption gap documented

### BL-058 (database startup) -> 001-database-startup/requirements.md
- Schema evolution deferral documented (per LRN-029)
- 3 duplicate test helpers identified with inconsistent DDL counts (8, 10, 12)
- Canonical 12 DDL statements identified
- CREATE TABLE IF NOT EXISTS design decision noted

### BL-062 (orphaned settings) -> 003-orphaned-settings/requirements.md
- `@lru_cache` safety documented for `get_settings()`
- Heartbeat interval read-at-connection-time behavior documented
- Default value matching (30 = 30) documented
- log_level exclusion (covered by BL-056) documented
- Full settings field inventory (9 fields) included

---

## 4. validate_version_design Tool

### Raw Result
```json
{
  "valid": true,
  "version": "v008",
  "themes_validated": 2,
  "features_validated": 4,
  "documents": {
    "found": 14,
    "missing": []
  },
  "consistency_errors": []
}
```

### Assessment
All expected documents present. No consistency errors. 14 documents found: VERSION_DESIGN.md, STARTER_PROMPT.md, THEME_INDEX.md, 2x THEME_DESIGN.md, 4x requirements.md, 4x implementation-plan.md.

---

## 5. Backlog Alignment

### Backlog Item -> Feature Mapping

| Backlog ID | Priority | Status | Feature | Theme |
|------------|----------|--------|---------|-------|
| BL-055 | P0 | open | 001-flaky-e2e-fix | 02-ci-stability |
| BL-056 | P1 | open | 002-logging-startup | 01-application-startup-wiring |
| BL-058 | P0 | open | 001-database-startup | 01-application-startup-wiring |
| BL-062 | P2 | open | 003-orphaned-settings | 01-application-startup-wiring |

### Acceptance Criteria Alignment

**BL-055** (3 ACs -> 4 feature requirements):
- AC1: toBeHidden passes across 10 consecutive CI runs -> FR-001 (match)
- AC2: No retry loops needed -> FR-002 (match)
- AC3: Fix doesn't alter functionality -> FR-003 (match)
- Feature adds: NFR-001 (explicit 10,000ms timeout matching project pattern)

**BL-056** (6 ACs -> 8 feature requirements):
- AC1: configure_logging() called at startup -> FR-001 (match)
- AC2: settings.log_level controls root logger -> FR-002 (match)
- AC3: DEBUG produces visible output -> FR-003 (match)
- AC4: All logger.info() calls visible -> FR-004 (match, notes 9 modules vs backlog's 10)
- AC5: uvicorn log_level from settings -> FR-005 (match)
- AC6: Tests pass with logging active -> FR-007 (match)
- Feature adds: FR-006 (idempotency — multiple calls don't duplicate handlers), NFR-001 (type conversion)

**BL-058** (4 ACs -> 7 feature requirements):
- AC1: Tables created automatically at startup -> FR-001 (match)
- AC2: Alembic or clear mechanism -> FR-002 (addressed via CREATE TABLE IF NOT EXISTS — documented design decision)
- AC3: Fresh database fully functional -> FR-005 (match)
- AC4: Existing tests pass -> FR-004 (match, plus consolidation of duplicate helpers)
- Feature adds: FR-003 (idempotency), NFR-001 (< 1s), NFR-002 (test mode bypass)

**BL-062** (3 ACs -> 4 feature requirements):
- AC1: settings.debug to FastAPI -> FR-001 (match)
- AC2: settings.ws_heartbeat_interval to ws.py -> FR-002 (match)
- AC3: No unconsumed settings -> FR-003 (match, excludes log_level per BL-056)
- Feature adds: NFR-001 (default behavior unchanged)

### Coverage Completeness
All 4 backlog items from VERSION_DESIGN.md are mapped. `manifest.json` confirms `deferred_items: []`. No items missing.

---

## 6. File Paths Exist

### Files to Modify (11 files — all verified)

| File | Exists | Modified By |
|------|--------|-------------|
| `src/stoat_ferret/db/schema.py` | Yes | 001-database-startup |
| `src/stoat_ferret/db/__init__.py` | Yes | 001-database-startup |
| `src/stoat_ferret/api/app.py` | Yes | 001-database-startup, 002-logging-startup, 003-orphaned-settings |
| `src/stoat_ferret/api/__main__.py` | Yes | 002-logging-startup, 003-orphaned-settings |
| `src/stoat_ferret/api/routers/ws.py` | Yes | 003-orphaned-settings |
| `src/stoat_ferret/logging.py` | Yes | 002-logging-startup |
| `tests/test_async_repository_contract.py` | Yes | 001-database-startup |
| `tests/test_project_repository_contract.py` | Yes | 001-database-startup |
| `tests/test_clip_repository_contract.py` | Yes | 001-database-startup |
| `tests/test_logging.py` | Yes | 002-logging-startup |
| `gui/e2e/project-creation.spec.ts` | Yes | 001-flaky-e2e-fix |

### Files to Create (3 files — parent directory verified)

| File | Parent Exists |
|------|--------------|
| `tests/test_database_startup.py` | Yes (`tests/`) |
| `tests/test_logging_startup.py` | Yes (`tests/`) |
| `tests/test_orphaned_settings.py` | Yes (`tests/`) |

### Shared Modification Points
- `app.py` modified by 3 features — sequential execution prevents conflicts
- `__main__.py` modified by 2 features — sequential execution prevents conflicts

---

## 7. Dependency Accuracy

### Theme Dependencies
- Theme 01 (application-startup-wiring): No external dependencies. All infrastructure already exists.
- Theme 02 (ci-stability): No dependencies on Theme 01. Fully independent — touches only frontend test infrastructure.

### Feature Dependencies (Theme 01)
```
001-database-startup
  -> 002-logging-startup
       -> 003-orphaned-settings
```
Rationale: All three modify `src/stoat_ferret/api/app.py` lifespan. Sequential execution prevents merge conflicts.

### Feature Dependencies (Theme 02)
- 001-flaky-e2e-fix: No dependencies (single feature in theme).

### Circular Dependency Check
No circular dependencies. Dependency graph is a simple linear chain within Theme 01 plus an independent Theme 02.

---

## 8. Mitigation Strategy

Not applicable. v008 fixes wiring gaps (BL-056, BL-058, BL-062) and a flaky test (BL-055). None of these bugs affect the auto-dev execution process itself. The flaky E2E test is isolated in Theme 02 and does not interfere with Theme 01's Python-only startup wiring work.

---

## 9. Design Docs Committed

### Git Status
```
Branch: main (tracking origin/main, 0 ahead / 0 behind)
Modified: comms/state/explorations/design-v008-009-validation-1771707878145.json (MCP state file)
Staged: 0
Untracked: 0
```

No inbox/execution documents are uncommitted. All 14 design documents are committed and tracked.

---

## 10. Handover Document

### STARTER_PROMPT.md Review
- References AGENTS.md (mandatory PR workflow, quality gates)
- Provides execution process (THEME_INDEX -> themes -> features)
- Specifies status tracking (STATUS.md)
- Lists output documents (completion-report.md, quality-gaps.md, handoff-to-next.md)
- Includes quality gates (ruff check, ruff format, mypy, pytest)
- Complete and actionable

---

## 11. Impact Analysis

### VERSION_DESIGN.md
- 3 constraints documented (wiring-only, sequential Theme 01, post-merge BL-055 AC)
- 3 assumptions documented (CREATE TABLE IF NOT EXISTS, idempotency fix, uvicorn log levels)

### THEME_DESIGN.md Files
- Theme 01: 3 risks with mitigations (app.py merge conflict, idempotency, test helper consolidation)
- Theme 02: 1 risk with mitigation (flake may not reproduce locally)

### Impact Table (comms/outbox/versions/design/v008/003-impact-assessment/impact-table.md)
- 16 impact items across 4 categories:
  - docs/setup (2): manual DB setup docs, env var descriptions
  - C4 docs (4): lifespan descriptions and Mermaid diagrams
  - caller-impact (8): code-level implementation impacts including async wrapper, test consolidation, type conversion, hardcoded values
  - test-compat (2): logging output in tests, test mode bypass

### Breaking Changes
None identified. All changes are additive wiring of existing infrastructure.

---

## 12. Naming Convention Validation

### Theme Folders (pattern: `^\d{2}-[a-z][a-z0-9-]*[a-z0-9]$`)

| Folder | Matches? |
|--------|----------|
| `01-application-startup-wiring` | Yes |
| `02-ci-stability` | Yes |

### Feature Folders (pattern: `^\d{3}-[a-z][a-z0-9-]*[a-z0-9]$`)

| Folder | Matches? |
|--------|----------|
| `001-database-startup` | Yes |
| `002-logging-startup` | Yes |
| `003-orphaned-settings` | Yes |
| `001-flaky-e2e-fix` | Yes |

### THEME_INDEX Feature Lines (pattern: `^- \d{3}-[a-z][a-z0-9-]*[a-z0-9]: .+$`)

| Line | Matches? |
|------|----------|
| `- 001-database-startup: Wire create_tables()...` | Yes |
| `- 002-logging-startup: Call configure_logging()...` | Yes |
| `- 003-orphaned-settings: Wire settings.debug...` | Yes |
| `- 001-flaky-e2e-fix: Fix toBeHidden()...` | Yes |

### Double-Numbering Check (pattern: `\d{2,3}-\d{2,3}-`)
No matches found. No double-numbered prefixes.

---

## 13. Cross-Reference Consistency

### THEME_INDEX -> Folder Structure

| Index Entry | Folder Path | Exists? |
|-------------|-------------|---------|
| Theme 01: application-startup-wiring | `v008/01-application-startup-wiring/` | Yes |
| Theme 02: ci-stability | `v008/02-ci-stability/` | Yes |
| Feature 001-database-startup (Theme 01) | `01-application-startup-wiring/001-database-startup/` | Yes |
| Feature 002-logging-startup (Theme 01) | `01-application-startup-wiring/002-logging-startup/` | Yes |
| Feature 003-orphaned-settings (Theme 01) | `01-application-startup-wiring/003-orphaned-settings/` | Yes |
| Feature 001-flaky-e2e-fix (Theme 02) | `02-ci-stability/001-flaky-e2e-fix/` | Yes |

### Folder Structure -> THEME_INDEX (reverse check)

All folders on disk appear in the THEME_INDEX. No orphan folders. Names match exactly (case-sensitive).
