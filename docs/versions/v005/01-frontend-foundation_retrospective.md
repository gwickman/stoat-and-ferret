# Theme 01: Frontend Foundation — Retrospective

## Theme Summary

Theme 01 delivered the foundational frontend infrastructure for stoat-and-ferret. This included scaffolding a React/TypeScript/Vite project, configuring FastAPI static file serving, adding a CI pipeline for frontend builds, implementing a WebSocket endpoint for real-time event broadcasting, and adding new settings fields with documentation updates. All three features completed successfully with all acceptance criteria met and all quality gates passing.

## Feature Results

| # | Feature | Acceptance | Quality Gates | Tests Added | Key Deliverable |
|---|---------|------------|---------------|-------------|-----------------|
| 001 | frontend-scaffolding | 5/5 Pass | ruff, mypy, pytest: Pass | 5 integration + 1 vitest | React/Vite/TS project in `gui/`, StaticFiles mount at `/gui`, CI `frontend` job |
| 002 | websocket-endpoint | 7/7 Pass | ruff, mypy, pytest: Pass | 23 (13 unit + 10 integration) | ConnectionManager, `/ws` endpoint, heartbeat, correlation IDs |
| 003 | settings-and-docs | 6/6 Pass | ruff, mypy, pytest: Pass | 6 settings tests | `thumbnail_dir`, `gui_static_path`, `ws_heartbeat_interval` fields; architecture/API/AGENTS docs |

**Totals:** 18/18 acceptance criteria passed. 35 new tests. Final test suite: 605 passed, 15 skipped, 93.23% coverage.

## Key Decisions

### Separate vitest.config.ts
**Context:** Vite 7 + vitest 4 don't support inline `test` config in `vite.config.ts` (TypeScript error).
**Choice:** Use a separate `vitest.config.ts` file.
**Outcome:** Clean separation of build and test configuration. No compatibility issues.

### Conditional StaticFiles Mount
**Context:** FastAPI's StaticFiles raises errors when the target directory doesn't exist (e.g., in test mode or before the first frontend build).
**Choice:** Only mount StaticFiles when `gui_static_path` points to an existing directory.
**Outcome:** Backend tests continue to work without requiring a frontend build. Clean DI integration.

### Tailwind CSS v4
**Context:** Tailwind CSS v4 uses a fundamentally different approach (no `tailwind.config.js`, uses `@tailwindcss/vite` plugin).
**Choice:** Adopted v4 with `@import "tailwindcss"` syntax.
**Outcome:** Simpler configuration, fewer files, modern tooling.

### Lazy Dead Connection Cleanup
**Context:** WebSocket connections can go stale. Two approaches: periodic scan vs. cleanup during broadcast.
**Choice:** Dead connections are cleaned up lazily during `broadcast()`, protected by `asyncio.Lock`.
**Outcome:** Simpler implementation, no background tasks needed, connections cleaned up when they matter most.

## Metrics

| Metric | Value |
|--------|-------|
| Features completed | 3/3 |
| Acceptance criteria passed | 18/18 |
| New tests added | 35 |
| Final test count | 605 passed, 15 skipped |
| Coverage | 93.23% (threshold: 80%) |
| Frontend bundle size | ~65KB gzipped |
| Frontend build time | 541ms |
| PRs merged | 3 (#63, #64, #65) |
| Quality gate iterations | 1 per feature (all first-pass) |

## Learnings

### What Went Well

- **DI pattern consistency:** The `create_app()` kwargs pattern (`ws_manager`, `gui_static_path`) worked cleanly for all new components, keeping test setup simple.
- **Feature sequencing:** Building scaffolding first, then WebSocket, then settings/docs was the right order. Each feature built on the previous one without rework.
- **All features passed on first iteration:** No quality gate failures or rework needed. The implementation plans were detailed enough to execute cleanly.
- **CI parallelism:** The frontend job runs in parallel with the Python test matrix, so CI time didn't increase significantly.

### What Could Improve

- **Frontend is still template content:** The `gui/src/App.tsx` still contains the default Vite React template. This is expected (Theme 03 will build the actual UI), but it means the frontend CI job validates infrastructure, not functionality.
- **No quality-gaps.md files generated:** Feature implementations completed cleanly enough that no quality gap documents were produced. This is a positive signal but means there's less structured tech debt tracking.

### Patterns Discovered

- **Vite 7 + vitest 4 config separation** is a noteworthy pattern for any React/Vite projects using the latest versions.
- **Conditional mount pattern** for optional static files is reusable for any FastAPI service that may or may not have a built frontend.
- **WebSocket integration via DI** (`app.state.ws_manager`) makes broadcasting from any endpoint straightforward — just access `request.app.state.ws_manager`.

## Technical Debt

No explicit quality-gaps.md files were generated by any feature. The following items are noted for backlog consideration:

1. **Default template UI:** `gui/src/App.tsx` contains the Vite default template. Must be replaced in Theme 03 with actual application components.
2. **Heartbeat interval hardcoded constant:** `DEFAULT_HEARTBEAT_INTERVAL` is a module-level constant; the settings field `ws_heartbeat_interval` exists but the wiring between settings and the WebSocket endpoint should be verified.
3. **No frontend E2E tests:** Only a smoke test (vitest) exists. E2E/integration testing of the React app with the backend is deferred.
4. **Dev proxy list maintenance:** The Vite dev proxy routes (`/api/*`, `/health/*`, `/metrics`, `/ws`) must be manually updated if new API prefixes are added.

## Recommendations

1. **Theme 03 should replace the template UI** immediately — the default Vite template should not persist beyond the next GUI theme.
2. **Add Playwright or Cypress** in a later version for frontend E2E testing, especially once actual UI components exist.
3. **Wire settings to WebSocket endpoint:** Ensure `ws_heartbeat_interval` from Settings flows through to the heartbeat loop, not just the module constant.
4. **Document the dev proxy update requirement** in AGENTS.md or a CONTRIBUTING guide so future API prefix additions don't break the Vite dev experience.
